"use strict";(self.webpackChunkweave_gitops_docs=self.webpackChunkweave_gitops_docs||[]).push([[26007],{68241:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>p,frontMatter:()=>a,metadata:()=>r,toc:()=>c});var o=i(87462),n=(i(67294),i(3905));const a={title:"Weave Policy Set",hide_title:!0},l="PolicySet",r={unversionedId:"policy/policy-set",id:"version-0.16.0/policy/policy-set",title:"Weave Policy Set",description:"This is an optional resource. It is used to select group of policies to work in specific modes.",source:"@site/versioned_docs/version-0.16.0/policy/policy-set.mdx",sourceDirName:"policy",slug:"/policy/policy-set",permalink:"/weave-gitops/docs/0.16.0/policy/policy-set",draft:!1,editUrl:"https://github.com/weaveworks/weave-gitops/edit/main/website/versioned_docs/version-0.16.0/policy/policy-set.mdx",tags:[],version:"0.16.0",frontMatter:{title:"Weave Policy Set",hide_title:!0},sidebar:"docs",previous:{title:"Weave Policy Agent Configuration",permalink:"/weave-gitops/docs/0.16.0/policy/configuration"},next:{title:"Weave Policy Configuration",permalink:"/weave-gitops/docs/0.16.0/policy/policy-configuration"}},s={},c=[{value:"Modes",id:"modes",level:2},{value:"Audit",id:"audit",level:3},{value:"Admission",id:"admission",level:3},{value:"Terraform Admission",id:"terraform-admission",level:3},{value:"Grouping Policies",id:"grouping-policies",level:2},{value:"Migration from v2beta1 to v2beta2",id:"migration-from-v2beta1-to-v2beta2",level:2},{value:"New fields",id:"new-fields",level:3},{value:"Example of the agent configuration in versions older than v2.0.0",id:"example-of-the-agent-configuration-in-versions-older-than-v200",level:4},{value:"Example of current PolicySet with mode field",id:"example-of-current-policyset-with-mode-field",level:4},{value:"Updated fields",id:"updated-fields",level:3},{value:"Deprecate fields",id:"deprecate-fields",level:3}],d={toc:c};function p(e){let{components:t,...i}=e;return(0,n.kt)("wrapper",(0,o.Z)({},d,i,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"policyset"},"PolicySet"),(0,n.kt)("p",null,"This is an optional resource. It is used to select group of policies to work in specific modes."),(0,n.kt)("p",null,"In each mode, The agent will list all the PolicySets of this mode and check which policies match any of those policysets, Then validate the resources against them."),(0,n.kt)("p",null,"If there is no policy set found all policies will work on all modes."),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"Note: ",(0,n.kt)("a",{parentName:"p",href:"/weave-gitops/docs/0.16.0/policy/#tenant-policy"},"Tenant Policies")," is always active in the ",(0,n.kt)("a",{parentName:"p",href:"#admission"},"Admission")," mode, event if it is not selected in the ",(0,n.kt)("inlineCode",{parentName:"p"},"admission")," policysets")),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Example")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: pac.weave.works/v2beta2\nkind: PolicySet\nmetadata:\n  name: my-policy-set\nspec:\n  mode: admission\n  filters:\n    ids:\n      - weave.policies.containers-minimum-replica-count\n    categories:\n      - security\n    severities:\n      - high\n      - medium\n    standards:\n      - pci-dss\n    tags:\n      - tag-1  \n")),(0,n.kt)("h2",{id:"modes"},"Modes"),(0,n.kt)("h3",{id:"audit"},"Audit"),(0,n.kt)("p",null,"This mode performs the audit functionality. It triggers per the specified interval (by default every 24 hour) and then lists all the resources in the cluster which the agent has access to read and validates those resources against the audit policies."),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"Works with policies of provider ",(0,n.kt)("inlineCode",{parentName:"p"},"kubernetes"))),(0,n.kt)("h3",{id:"admission"},"Admission"),(0,n.kt)("p",null,"This contains the admission module that enforces policies. It uses the ",(0,n.kt)("inlineCode",{parentName:"p"},"controller-runtime")," Kubernetes package to register a callback that will be called when the agent receives an admission request. Once called, the agent will validate the received resource against the admission and tenant policies and k8s will use the result of this validation to either allow or reject the creation/update of said resource."),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"Works with policies of provider ",(0,n.kt)("inlineCode",{parentName:"p"},"kubernetes"))),(0,n.kt)("h3",{id:"terraform-admission"},"Terraform Admission"),(0,n.kt)("p",null,"This is a webhook used to validate terraform plans. It is mainly used by the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/weaveworks/tf-controller"},"TF-Controller")," to enforce policies on terraform plans"),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"Works with policies of provider ",(0,n.kt)("inlineCode",{parentName:"p"},"terraform"))),(0,n.kt)("h2",{id:"grouping-policies"},"Grouping Policies"),(0,n.kt)("p",null,"Policies can be grouped by their ids, categories, severities, standards and tags"),(0,n.kt)("p",null,"The policy will be matched if any of the filters are matched."),(0,n.kt)("h2",{id:"migration-from-v2beta1-to-v2beta2"},"Migration from v2beta1 to v2beta2"),(0,n.kt)("h3",{id:"new-fields"},"New fields"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"New required field ",(0,n.kt)("inlineCode",{parentName:"li"},"spec.mode")," is added. PolicySets should be updated to set the mode")),(0,n.kt)("p",null,"Previously the agent was configured with which policysets to use in each mode. Now we removed this argument from the agent's configuration and\nadd the mode to the Policyset itself. "),(0,n.kt)("h4",{id:"example-of-the-agent-configuration-in-versions-older-than-v200"},"Example of the agent configuration in versions older than v2.0.0"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"# config.yaml\nadmission:\n   enabled: true\n   policySet: admission-policy-set\n   sinks:\n      filesystemSink:\n         fileName: admission.txt\n")),(0,n.kt)("h4",{id:"example-of-current-policyset-with-mode-field"},"Example of current PolicySet with mode field"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: pac.weave.works/v2beta2\nkind: PolicySet\nmetadata:\n  name: admission-policy-set\nspec:\n  mode: admission\n  filters:\n    ids:\n      - weave.policies.containers-minimum-replica-count\n")),(0,n.kt)("h3",{id:"updated-fields"},"Updated fields"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Field ",(0,n.kt)("inlineCode",{parentName:"li"},"spec.name")," became optional.")),(0,n.kt)("h3",{id:"deprecate-fields"},"Deprecate fields"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Field ",(0,n.kt)("inlineCode",{parentName:"li"},"spec.id")," is deprecated.")))}p.isMDXComponent=!0},3905:(e,t,i)=>{i.d(t,{Zo:()=>d,kt:()=>f});var o=i(67294);function n(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function a(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,o)}return i}function l(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?a(Object(i),!0).forEach((function(t){n(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):a(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function r(e,t){if(null==e)return{};var i,o,n=function(e,t){if(null==e)return{};var i,o,n={},a=Object.keys(e);for(o=0;o<a.length;o++)i=a[o],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)i=a[o],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}var s=o.createContext({}),c=function(e){var t=o.useContext(s),i=t;return e&&(i="function"==typeof e?e(t):l(l({},t),e)),i},d=function(e){var t=c(e.components);return o.createElement(s.Provider,{value:t},e.children)},p="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},m=o.forwardRef((function(e,t){var i=e.components,n=e.mdxType,a=e.originalType,s=e.parentName,d=r(e,["components","mdxType","originalType","parentName"]),p=c(i),m=n,f=p["".concat(s,".").concat(m)]||p[m]||u[m]||a;return i?o.createElement(f,l(l({ref:t},d),{},{components:i})):o.createElement(f,l({ref:t},d))}));function f(e,t){var i=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var a=i.length,l=new Array(a);l[0]=m;var r={};for(var s in t)hasOwnProperty.call(t,s)&&(r[s]=t[s]);r.originalType=e,r[p]="string"==typeof e?e:n,l[1]=r;for(var c=2;c<a;c++)l[c]=i[c];return o.createElement.apply(null,l)}return o.createElement.apply(null,i)}m.displayName="MDXCreateElement"}}]);